<apex:page controller="PortfolioMapController" showHeader="false" standardStylesheets="false" lightningStylesheets="true" sidebar="false" applyHtmlTag="false" applyBodyTag="false" docType="html-5.0">
<html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <title>Portfolio Map</title>
        <apex:slds />
        <link href="{!URLFOR($Resource.SlimSelect1_15_1, 'slimselect.min.css')}" rel="stylesheet"></link>
        <style>
            #map {
                font-family: Arial;
                font-size:12px;
                line-height:normal !important;
                height: 82%;
                min-height: 400px;
                width: 100%;
                background:transparent;
            }
            html, body {
                height:100%;
                overflow:hidden;
            }
        </style>
    </head>
    <body class="slds-scope">
        <script type="text/javascript">
        </script>
        <apex:includeScript value="https://code.jquery.com/jquery-1.9.1.js"/>
        <apex:includeScript value="https://code.jquery.com/ui/1.10.3/jquery-ui.js"/>
        <!-- Google API Key is stored in custom setting GoogleAPISettings and is editable in Salesforce Setup -->
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={!$Setup.GoogleAPISettings__c.Maps_JavaScript_API_Key__c}"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js?key={!$Setup.GoogleAPISettings__c.Maps_JavaScript_API_Key__c}"></script>
        <!-- markerclusterer is from: https://github.com/googlemaps/v3-utility-library/tree/master/markerclusterer -->
        <script src="{!URLFOR($Resource.GoogleMapsMarkerClusterer, 'markerclusterer/src/markerclusterer.js')}"></script>
        <!-- Overlapping Marker Spiderfier is from: https://github.com/jawj/OverlappingMarkerSpiderfier -->
        <script src="{!URLFOR($Resource.OverlappingMarkerSpiderfier1_0_3, 'oms.min.js')}"></script>
        <!-- SlimSelect is from: https://github.com/brianvoe/slim-select -->
        <script src="{!URLFOR($Resource.SlimSelect1_15_1, 'slimselect.min.js')}"></script>
        <script type="text/javascript">
        function sleep(milliseconds) {
            var start = new Date().getTime();
            for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds){
                    break;
                }
            }
        }

        $(document).ready(function() {
            var myOptions = {
                center: new google.maps.LatLng(34.2257, -77.9447),
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            var spiderConfig = {
                keepSpiderfied: true,
                event: 'mouseover'
            };

            var accounts = {!listAccounts};
            var map = new google.maps.Map(document.getElementById("map"), myOptions);
            var markers = [];
            var geocoder = new google.maps.Geocoder();
            var markerBounds = new google.maps.LatLngBounds();
            var markerSpiderfier = new OverlappingMarkerSpiderfier(map, spiderConfig);

            // Loop through each account and build a full street address and tool tip
            // Add them to the map one at a time.

            $.each(accounts, function(i, item) {
                // use the latitude and longitude stored in Salesforce to add a marker to the map
                if (item.ShippingLatitude && item.ShippingLongitude) {
                    var sfLatLong = {lat: item.ShippingLatitude, lng: item.ShippingLongitude};

                    //console.log('using Salesforce coordinates: ' + JSON.stringify(sfLatLong));

                    // Account/001m000000bu3ODAAY/view
                    var tooltip
                    if({!SiteName!=null}){
                        tooltip = "<b>Name:</b> <a href='/alliance/s/detail/" + item.Id + "' target='_blank'> "+ item.Name + "</a><br>";
                    }else{
                          tooltip = "<b>Name:</b> <a href='../lightning/r/Account/" + item.Id + "/view' target='_blank'> "+ item.Name + "</a><br>";  
                    }
                    tooltip += "<b>Funding Status:</b> " + (item.Funding_Status__c ? item.Funding_Status__c : "") + "<br>";
                    tooltip += "<b>Total Funding Amount:</b> " + (item.Total_Funding_Amount__c ? item.Total_Funding_Amount__c : "") + "<br>";
                    tooltip += "<b>Number of Investors:</b> " + (item.Number_of_Investors__c ? item.Number_of_Investors__c : "") + "<br>";
                    tooltip += "<b>Founded Date:</b> " + (item.Founded_Date__c ? item.Founded_Date__c : "") + "<br>";
                    tooltip += "<b>Number of Employees:</b> " + (item.Number_of_Employees__c ? item.Number_of_Employees__c : "") + "<br>";

                    var marker = new google.maps.Marker({
                        map: map,
                        position: sfLatLong});
                    markers.push(marker);
                    markerSpiderfier.addMarker(marker);
                    
                    markerBounds.extend(sfLatLong);
                    map.fitBounds(markerBounds);

                    var infoWindow = new google.maps.InfoWindow();

                    google.maps.event.addListener(marker, 'click', function () {
                        infoWindow.setContent(tooltip);
                        infoWindow.open(map, this);
                    });
                }
            }); //End each

            // add clusters for grouped markers
            var markerCluster = new MarkerClusterer(map, markers, {
                imagePath: "{!SUBSTITUTE(URLFOR($Resource.GoogleMapsMarkerClusterer, 'markerclusterer/images/m1.png'), '1.png', '')}",
                maxZoom: 15,
                gridSize: 40
            });
        });   // End ready
        </script>

        <!--div class="slds-card__header slds-grid">
            <header class="slds-media slds-media_center slds-has-flexi-truncate" style="display:flex;">
                <div class="slds-media__figure">
                    <span class="slds-icon_container slds-icon-custom-custom78" title="map">
                    <svg class="slds-icon" aria-hidden="true" style="width: 2rem; height: 2rem;">
                        <use xlink:href="{!URLFOR($Asset.SLDS, '/assets/icons/custom-sprite/svg/symbols.svg#custom78')}"></use>
                    </svg>
                    </span>
                </div>
                <div class="slds-media__body">
                    <h2 class="slds-card__header-title">
                    <a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Ventures Map">
                        <span class="slds-text-heading_small">Ventures Map</span>
                    </a>
                    </h2>
                </div>
            </header>
        </div-->
        <div class="slds-card__body slds-card__body_inner" style="height:90%">
            <apex:pageMessages />
            <div class="slds-grid slds-gutters" style="display:flex;height:100%">
                <div class="slds-col slds-size_3-of-4" style="width: 75%; padding-right: .75rem;padding-left: .75rem;">   
                    <div id="map"/>
                </div>
                <div class="slds-col slds-size_1-of-4 slds-hide" id="filters" style="width: 25%; padding-right: .75rem;padding-left: .75rem;">
                    <apex:form >

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Account Type</label>
                            <div class="slds-form-element__control">
                                <apex:selectList id="AccTypes" multiselect="true" size="6" value="{!accountTypeVal}" style="width: 100%;">
                                     <apex:actionSupport event="onchange" action="{!SelectAllTypes}" reRender="AccTypes" focus="AccTypes" />
                                    <apex:selectOptions value="{!items}"/>
                                </apex:selectList>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Country</label>
                            <div class="slds-form-element__control">
                                <apex:selectList html-class="countryselect" value="{!countries}" multiselect="true">
                                    <apex:selectOptions value="{!countryItems}"/>
                                </apex:selectList>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">State</label>
                            <div class="slds-form-element__control">
                                <apex:selectList html-class="stateselect" value="{!states}" multiselect="true">
                                    <apex:selectOptions value="{!stateItems}"/>
                                </apex:selectList>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Total Funding Amount</label>
                            <div class="slds-form-element__control">
                                <apex:inputText html-placeholder="min" value="{!totalFundingMin}" style="width:48%;"/>
                                <apex:inputText html-placeholder="max" value="{!totalFundingMax}" style="width:48%;"/>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Number of Investors</label>
                            <div class="slds-form-element__control">
                                <apex:inputText html-placeholder="min" value="{!numInvestorsMin}" style="width:48%;"/>
                                <apex:inputText html-placeholder="max" value="{!numInvestorsMax}" style="width:48%;"/>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Founding Year</label>
                            <div class="slds-form-element__control">
                                <apex:inputText html-placeholder="min" value="{!foundingYearMin}" style="width:48%;"/>
                                <apex:inputText html-placeholder="max" value="{!foundingYearMax}" style="width:48%;"/>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Number of Employees</label>
                            <div class="slds-form-element__control">
                                <apex:selectList html-class="numemployeesselect" value="{!numEmployees}" multiselect="true">
                                    <apex:selectOptions value="{!numEmployeesItems}"/>
                                </apex:selectList>
                            </div>
                        </div>

                        <div class="slds-form-element">
                            <label class="slds-form-element__label"></label>
                            <div class="slds-form-element__control"></div>
                        </div>

                        <div class="slds-button-group" role="group">
                            <apex:commandButton value="Apply Filter" action="{!runSearch}" styleClass="slds-button slds-button--neutral slds-not-selected"/>
                        </div>

                        <script type="text/javascript">
                            new SlimSelect({
                                select: '.countryselect'
                            });

                            new SlimSelect({
                                select: '.stateselect'
                            });

                            new SlimSelect({
                                select: '.numemployeesselect'
                            });
                            
                            document.getElementById('filters').classList.add('slds-show');
                            document.getElementById('filters').classList.remove('slds-hide');
                        </script>
                    </apex:form>
                </div>
            </div>
        </div>

    </body>
</html>
</apex:page>