<apex:page Controller="PortfolioCompanyFinancials" showHeader="false" sidebar="false" standardStylesheets="true" docType="html-5.0">

    <apex:includeScript value="{!URLFOR($Resource.jquery)}" />
    <apex:includeScript value="{!URLFOR($Resource.DHTMLX, '/codebase/dhtmlx.js')}" />
    <apex:stylesheet value="{!URLFOR($Resource.DHTMLX, '/skins/material/dhtmlx.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.DHTMLX, '/skins/terrace/dhtmlx.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.DHTMLX, '/skins/web/dhtmlx.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.DHTMLX, '/skins/skyblue/dhtmlx.css')}" />


    <style type="text/css" media="screen">
        html,
        body {
            margin: 0px;
            padding: 0px;
            height: 100%;
            overflow: hidden !important;
        }

        .dhxwins_vp_auto {
            overflow: hidden !important;
        }

        div#layoutObj {
            position: relative;
            /*margin-top: 15px;*/
            margin-left: 0px;
            width: 100%;
            /*height: 364px;*/
        }

        .uneven {
            background-color: #f3f3f3a1;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /*div.gridbox_material.gridbox table.obj tr td {
            border-bottom: 1px solid rgb(205, 202, 202);
        }*/

        .grid_hover {
            background-color: #f9d3f136;
        }

        div.gridbox_material.gridbox table.obj tr td,
        .dhx_grid_adjust,
        .standartTreeRow {
            font-size: 13px;
        }

        .dhx_cell_hdr_text input {
            display: none;
        }



        .dhtmlx-info a {
            text-decoration: underline;
        }

        .dhx_combo_edit {
            text-align: left;
        }

        div.gridbox div.ftr td {
            font-style: normal !important;
            background-color: #e2efff;
            border: none;
        }

        div.gridbox_dhx_terrace.gridbox .ftr table td {
            line-height: 21px !important;
        }

        .group_row {
            border: none !important;
        }


        .td_btn_img {
            display: none
        }

        #wrapper {
            height: 400px;
        }

        .tribute-container li {
            margin-left: 0px !important;
        }

        div.gridbox_dhx_terrace.gridbox table.obj tr td {
            padding-left: 5px !important;
            padding-right: 5px !important;
        }

        .dhx_toolbar_dhx_terrace {
            padding: 0px;
        }

        .formHeaderLabel div {
            color: black !important;
            font-size: 16px !important;
        }

        .formCatLabel div {
            color: black !important;
        }

        .uplDocLabel div {
            color: black !important;
            text-align: center !important;
            font-size: 11px !important;
            font-weight: 100 !important;
        }

        .blueLayout {
            background-color: #dbeafd !important;
        }
    </style>

    <body id="body">
        <div id="wrapper">
            <div id="layoutObj">

            </div>
            <br/>
            <br/>
            <br/>
        </div>

        <script type="text/javascript">



            var FinancialReportRequestWinLayout;
            let today = new Date();
            var quarter = 'Q' + Math.floor((today.getMonth() + 3) / 3) + ', ' + today.getFullYear();


            function eXcell_perc(cell) { //the eXcell name is defined here
                if (cell) {                 //the default pattern, just copy it
                    this.cell = cell;
                    this.grid = this.cell.parentNode.grid;
                    eXcell_ed.call(this); //uses methods of the "ed" type
                }
                this.setValue = function (val) {
                    this.setCValue("" + val + "%", val);
                }
                this.getValue = function () {
                    //console.log(this.cell);
                    return this.cell.innerHTML.replace('%', ''); // gets the value
                }
            }
            eXcell_perc.prototype = new eXcell;



            function sendToLC(param, recordId) {
                let searchParams = new URLSearchParams(window.location.href);
                var lexOrigin = 'https://' + searchParams.get('returnUrl');
                var message = { param: param, recordId: recordId };
                parent.postMessage(message, lexOrigin);
            }

            var yPos;
            var xPos;
            $("body").mousemove(function (e) {
                yPos = e.pageY;
                xPos = e.pageX;
            })

            var formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });

            var ParentUrl = (window.location != window.parent.location) ? document.referrer : document.location.href;
            parent.postMessage('setBaseUrl' + '-del-' + document.location.href, ParentUrl);

            Date.prototype.monthNames = [
                "January", "February", "March",
                "April", "May", "June",
                "July", "August", "September",
                "October", "November", "December"
            ];
            Date.prototype.getMonthName = function () {
                return this.monthNames[this.getMonth()];
            };
            Date.prototype.getShortMonthName = function () {
                return this.getMonthName().substr(0, 3);
            };

            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                vars[key] = value;
            });
            var recordId = vars["recordId"];
            var dhtmlxSkin = vars["skin"];
            var communityName = vars["communityName"];
            var isCommunity;
            var componentHeight = vars["componentHeight"];
            var quarterParam = vars["quarter"];
            var isAllowEditing;
            var accName;

            var jsRounds;
            var jsFinCats;
            var advancedEditWin;
            var RoundTooltip;
            var exportHeaderLabels;

            var doNotShowRFRmodal = false;
            var currentQuarterColNumber;

            var CatGrid;

            var componentHeightInt = Number(componentHeight);
            componentHeightInt = componentHeightInt - 36;
            document.getElementById("layoutObj").style.height = componentHeightInt + "px";

            var lSkin = "dhx_" + dhtmlxSkin;
            if (dhtmlxSkin == 'material') {
                lSkin = dhtmlxSkin;
            }

            if (dhtmlxSkin == 'material') {
                var sheet = document.createElement('style')
                sheet.innerHTML = ".dhxgrid_sort_desc, .dhxgrid_sort_asc {width:0px;} .selectedTreeRow {background-color: transparent;}";
                document.body.appendChild(sheet);
            }

            eXcell_link.prototype.getTitle = eXcell_link.prototype.getContent;


            Layout = new dhtmlXLayoutObject({
                parent: "layoutObj",
                pattern: "1C",
                cells: [{ id: "a", text: "dhtmlxGrid" }],
                skin: lSkin
            });
            Layout.cells("a").hideHeader();

            var CapSharesGrid;


            if (quarterParam)
                refreshGrid();


            function refreshGrid() {
                Layout.cells("a").progressOn();
                PortfolioCompanyFinancials.getCapTableData(quarterParam, function (result, event) {
                    if (event.type == 'exception') {
                        //alert(event.message);
                    } else {
                        var data = result;
                        console.log(data);


                        try { CapSharesGrid.destructor(); } catch (e) { }
                        CapSharesGrid = Layout.cells("a").attachGrid();

                        var columns = [];
                        columns = data.columns;
                        console.log(columns.length);

                        var TableHeaders = 'Portfolio Company,';
                        var TableWidths = '"",';
                        var TableAligns = 'left,';
                        var TableColTypes = 'link,';
                        var TableColSorting = 'str,';

                        for (var i = 0; i <= columns.length - 1; i++) {
                            console.log(columns[i]);
                            TableHeaders += columns[i].Portfolio_Column__c + ',';
                            TableWidths += '"",';
                            TableAligns += 'left,';
                            TableColTypes += 'ron,';
                            TableColSorting += 'str,';

                        }
                        console.log(TableColTypes);
                        TableHeaders = TableHeaders.replace(/,\s*$/, "");
                        TableWidths = TableWidths.replace(/,\s*$/, "");
                        TableAligns = TableAligns.replace(/,\s*$/, "");
                        TableColTypes = TableColTypes.replace(/,\s*$/, "");
                        TableColSorting = TableColSorting.replace(/,\s*$/, "");


                        CapSharesGrid.setHeader(TableHeaders);

                        CapSharesGrid.setInitWidths(TableWidths);
                        CapSharesGrid.setColAlign(TableAligns);
                        CapSharesGrid.setColTypes(TableColTypes);
                        CapSharesGrid.setColSorting(TableColSorting);

                        CapSharesGrid.enableAlterCss("even", "uneven");
                        CapSharesGrid.enableRowsHover(true, 'grid_hover');
                        CapSharesGrid.setImagePath("{!URLFOR($Resource.DHTMLX)}" + '/skins/' + dhtmlxSkin + '/imgs/dhxgrid_' + dhtmlxSkin + '/');
                        CapSharesGrid.init();

                        for (var i = 0; i <= columns.length - 1; i++) {

                            if (columns[i].Type__c == 'Currency') {
                                CapSharesGrid.setNumberFormat("$0,000.00", i + 1, ".", ",");
                            } else if (columns[i].Type__c == 'Number') {
                                CapSharesGrid.setNumberFormat("0,000.00", i + 1, ".", ",");
                            } else if (columns[i].Type__c == 'Percent') {
                                CapSharesGrid.setNumberFormat("0,000%", i + 1, ".", ",");
                            }

                        }

                        //CapSharesGrid.clearAll();
                        var res = data.data;
                        res = ($('<div>').html(res).text());
                        //console.log(res);
                        CapSharesGrid.parse(res, "json");
                        Layout.cells("a").progressOff();




                        /* CapSharesGrid.forEachRow(function (row_id) {
                             CapSharesGrid.forEachCell(row_id, function (cellObj, col_index) {
                                 if (col_index > 1) {
                                     let type = CapSharesGrid.getUserData(row_id, "Type");
                                     if (type == 'Currency') {
                                         CapSharesGrid.setCellExcellType(row_id, col_index, "edn");//price
                                         CapSharesGrid.setNumberFormat("$0,000.00", col_index, ".", ",");
                                         if (CapSharesGrid.cells(row_id, col_index).getValue() < 0) {
                                             CapSharesGrid.setCellTextStyle(row_id, col_index, "color:red;text-align:right;");
                                         } else {
                                             CapSharesGrid.setCellTextStyle(row_id, col_index, "color:green;text-align:right;");
                                         }
                                     } else if (type == 'Number') {
                                         CapSharesGrid.setCellExcellType(row_id, col_index, "edtxt");
                                         CapSharesGrid.setCellTextStyle(row_id, col_index, "text-align:right;");
                                         //CapSharesGrid.setNumberFormat("0,000", col_index, ".", ",");
                                     } else if (type == 'Percentage') {
                                         CapSharesGrid.setCellExcellType(row_id, col_index, "perc");
                                         CapSharesGrid.setCellTextStyle(row_id, col_index, "text-align:right;");
                                     } else if (type == 'Text') {
                                         CapSharesGrid.setCellExcellType(row_id, col_index, "edtxt");
                                     } else if (type == 'Date') {
                                         CapSharesGrid.setCellExcellType(row_id, col_index, "dhxCalendar");
                                     }
                                 }
                             });
                         });*/


                    }
                });

            }





            function stopPropagation(e) {
                e.stopImmediatePropagation();
            }

            String.prototype.replaceAll = function (search, replace) {
                return this.split(search).join(replace);
            }

            if (window.attachEvent)
                window.attachEvent("onresize", resizeLayout);
            else
                window.addEventListener("resize", resizeLayout, false);
            function resizeLayout() {
                window.clearTimeout(t);
                var t = window.setTimeout(function () {
                    Layout.setSizes(false);
                }, 200);
            }

            function pad(n) { return n < 10 ? '0' + n : n }

        </script>

    </body>
</apex:page>